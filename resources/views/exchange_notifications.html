{% extends 'common.html' %}

{% block content %}
<section class="page-box">
	<h1> Book exchanges </h1>

	<div class = "requests">
	</div>
</section>
{% endblock %}

<script>

function getUserID(token)
{
	var token = Cookies.get('token');
	if(token)
	{
		var api_addr = '/getuserbytoken?token={0}'.format(token);
		$.ajax({
			url: '{{ api_address() }}' + api_addr,
			success: function(response){
				if('status' in response && 
					'response' in response &&
					response['status'] == 'succes')
					return response['response']['userid']
			}
		})
	}
}

function getBookInfo(token, id)
{
	var token = Cookies.get('token');
	if(token)
	{
		var api_addr = '/book?token={0}&id={1}'.format(token, id);
		$.ajax({
			url: '{{ api_address() }}' + api_addr,
			success: function(response){
				if('status' in response && 
					'response' in response &&
					response['status'] == 'succes')
					return response['response']
			}
		});
	}
}


function placeRequests()
{
	var token = Cookies.get('token');
	if(token)
	{
		var api_addr = '/exchange/listoffers?token={0}'.format(token);
		$.ajax({
			url: '{{ api_address() }}' + api_addr,
			success: function(response) {
				if('status' in response && 
				   'response' in response &&
				   response['status'] == 'succes')
				{
					exchanges = response['response'];
					status_exchange = response['exchange_status'];

					userID = getUserID(token)

					exchanges.forEach(function(request){
						book_info1 = getBookInfo(token, request['EXCHANGES.BOOKID1']);
						book_info2 = getBoogInfo(token, request['EXCHANGES.BOOKID2']);

						exchange_info = {}
						exchange_info['image1'] = book_info1['cover'];
						exchange_info['title1'] = book_info1['title'];
						exchange_info['author1'] = book_info1['author'];
						exchange_info['added1'] = book_info1['author'];

						exchange_info['image2'] = book_info2['cover'];
						exchange_info['title2'] = book_info2['title'];
						exchange_info['author2'] = book_info2['author'];
						exchange_info['added2'] = book_info2['author'];

						bookHTML = getExchangeTemplate();
						$('#requests').append(bookHTML);
					});
				}
			}
		});
	}
}